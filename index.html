<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>[v2.22.0] Futures Pro Terminal - Precision Layout</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --primary: #1a1a1a; --accent: #f3d42f; --success: #00c853; --danger: #ff3d00; --bg: #080808; --text: #e0e0e0; --border: #1a1a1a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 8px; margin: 0; }
        .container { max-width: 1600px; margin: auto; }
        
        /* Cabe√ßalho com Labels Restaurados */
        .header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 15px 20px; background: #111; border-radius: 12px; border: 1px solid var(--border); }
        .header-label { font-size: 0.55rem; color: #555; text-transform: uppercase; font-weight: 800; display: block; margin-bottom: 4px; letter-spacing: 0.5px; }
        .equity-value { font-size: 1.8rem; font-weight: 900; color: #fff; letter-spacing: -1px; line-height: 1; }
        .pnl-stack { text-align: right; }
        .pnl-main { font-size: 1.3rem; font-weight: 800; line-height: 1; }

        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
        .card { background: #121212; padding: 10px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .card label { color: #555; font-size: 0.55rem; text-transform: uppercase; font-weight: 800; display: block; margin-bottom: 2px; }
        .card span { font-size: 0.9rem; font-weight: 700; color: #eee; }

        .asset-nav { display: flex; gap: 6px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .nav-btn { background: #151515; color: #666; border: 1px solid #222; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.75rem; white-space: nowrap; transition: 0.2s; }
        .nav-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Grelha 80/20 Otimizada */
        .overview-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 1024px) { 
            .overview-grid { grid-template-columns: 8fr 2fr; height: 500px; } 
        }
        
        .chart-card { background: #111; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .chart-header { background: #161616; padding: 8px 12px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .chart-header h3 { margin: 0; font-size: 0.6rem; text-transform: uppercase; color: #555; letter-spacing: 1px; }
        .chart-container { flex: 1; min-height: 350px; width: 100%; }

        #ticker-container { height: 650px; width: 100%; display: none; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }

        .bottom-legend { display: flex; flex-wrap: wrap; gap: 10px; padding: 12px; background: #111; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; margin-top: -10px; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: #888; cursor: pointer; padding: 4px 10px; border-radius: 6px; background: #181818; border: 1px solid #222; }
        .legend-color { width: 8px; height: 8px; border-radius: 50%; }
        .legend-item.hidden { opacity: 0.2; }

        .trade-panel { background: #111; padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; position: relative; }
        .editing-notice { position: absolute; top: -10px; right: 20px; background: var(--accent); color: #000; font-size: 0.6rem; padding: 3px 10px; border-radius: 5px; font-weight: 900; }
        .field { flex: 1 1 calc(18% - 10px); min-width: 100px; }
        .field label { font-size: 0.55rem; color: #555; text-transform: uppercase; display: block; margin-bottom: 4px; font-weight: 800; }
        input, select { background: #080808; border: 1px solid #222; color: white; padding: 10px; border-radius: 8px; font-size: 0.85rem; width: 100%; }
        .exec-btn { background: var(--accent); color: #000; font-weight: 900; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; }
        
        .table-section { margin-top: 15px; border-radius: 12px; border: 1px solid var(--border); background: #111; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 15px; font-size: 0.65rem; color: #555; text-transform: uppercase; background: #161616; }
        td { padding: 14px 15px; border-bottom: 1px solid #181818; font-size: 0.8rem; font-family: 'Roboto Mono', monospace; }
        .badge-long { color: var(--success); font-weight: bold; }
        .badge-short { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="asset-nav" id="assetNav"></div>
    
    <div class="header-info">
        <div class="header-block">
            <span class="header-label">Portfolio Equity</span>
            <div class="equity-value" id="dispEquity">SYNC...</div>
        </div>
        <div class="pnl-stack">
            <span class="header-label">Active P&L</span>
            <div class="pnl-main" id="dispPnlVal">--</div>
            <div id="dispPnlPerc" style="font-size: 0.8rem; font-weight: bold; margin-top: 2px;">0.00%</div>
        </div>
    </div>

    <div class="dashboard" id="mainDashboard" style="display:none;">
        <div class="card"><label>Price</label><span id="v1">---</span></div>
        <div class="card"><label>Entry</label><span id="v2">---</span></div>
        <div class="card"><label>Leverage</label><span id="v3">---</span></div>
        <div class="card"><label>Liquidation</label><span id="v5" style="color:var(--danger)">---</span></div>
    </div>

    <div id="overview-container">
        <div class="overview-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Performance Curve</h3>
                    <div id="lineControls" style="display:flex; gap:4px;">
                        <button id="btn5m" class="nav-btn active" onclick="updateOverview('5', this)">5m</button>
                        <button class="nav-btn" onclick="updateOverview('60', this)">1h</button>
                        <button class="nav-btn" onclick="updateOverview('240', this)">4h</button>
                        <button class="nav-btn" onclick="updateOverview('D', this)">1D</button>
                    </div>
                </div>
                <div id="chart" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>P&L Periodic</h3>
                    <div id="barControls" style="display:flex; gap:4px;">
                        <button id="bar1d" class="nav-btn active" onclick="updateBarChart('D', this)">1D</button>
                        <button class="nav-btn" onclick="updateBarChart('W', this)">1W</button>
                    </div>
                </div>
                <div id="bar-chart" class="chart-container"></div>
            </div>
        </div>
        <div id="bottomLegend" class="bottom-legend"></div>
    </div>

    <div id="ticker-container"></div>

    <div class="trade-panel" id="tradePanel">
        <div class="editing-notice" id="editLabel" style="display:none;">EDITING TRADE</div>
        <input type="hidden" id="editId">
        <div class="field"><label>Ticker</label><input type="text" id="parTicker" placeholder="BTCUSDT"></div>
        <div class="field"><label>Side</label><select id="tType"><option value="Compra">LONG</option><option value="Venda">SHORT</option></select></div>
        <div class="field"><label>Price</label><input type="number" id="tPrice" step="any"></div>
        <div class="field"><label>Leverage</label><input type="number" id="tLev" value="10"></div>
        <div class="field"><label>Qty</label><input type="number" id="tQty" step="any"></div>
        <div style="display:flex; gap:8px; align-items: flex-end;">
            <button class="exec-btn" id="execBtn" onclick="saveTrade()">EXECUTE</button>
            <button class="nav-btn" id="resetBtn" onclick="resetForm()" style="display:none; background:#333;">CANCEL</button>
        </div>
    </div>

    <div class="table-section">
        <div class="table-container"><table><tbody id="tradeLog"></tbody></table></div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    const MY_TV_CHART_ID = "Mv5udZuO"; 
    const SUPABASE_URL = 'https://pmdvckcxwfiwhrhibupo.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bRa-mZWTaf0g6sNyWL9OmQ_uvo7Ex5H';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentMode = "OVERVIEW", currentSymbol = "", activePrices = {}, allTrades = [];
    let chart, barChart, mainLine, zeroLine, barSeries, subLines = {}, seriesVisibility = { "TOTAL": true };
    const colors = ['#f3d42f', '#ff6b6b', '#4dabf7', '#51cf66', '#cc5de8', '#ff922b'];

    async function fetchPrices() { try { const r = await fetch('https://api.bybit.com/v5/market/tickers?category=linear'); const d = await r.json(); if(d.result?.list) d.result.list.forEach(i => activePrices[i.symbol] = parseFloat(i.markPrice)); } catch(e) {} }
    function getPosition(ticker) { let q = 0, cost = 0, margin = 0; allTrades.filter(t => t.par === ticker).forEach(t => { const nom = t.preco * t.quantidade; const m = nom / (t.alavancagem_alvo || 1); if (t.tipo === "Compra") { q += t.quantidade; cost += nom; margin += m; } else { const ratio = t.quantidade / (q || 1); margin -= (margin * ratio); cost -= (cost * ratio); q -= t.quantidade; } }); return { q, cost, margin }; }
    
    function updateUI() { 
        if (Object.keys(activePrices).length === 0) return; 
        let gPL = 0, gMarg = 0; 
        [...new Set(allTrades.map(t => t.par))].forEach(tic => { 
            const s = getPosition(tic); 
            if (Math.abs(s.q) > 0.0001) { 
                const p = activePrices[tic] || 0, pl = (p - (s.cost/s.q)) * s.q; 
                gPL += pl; gMarg += s.margin; 
                if (currentMode === "TICKER" && tic === currentSymbol) { 
                    const avg = s.cost/s.q, eq = s.margin+pl, pP = (pl/s.margin)*100;
                    document.getElementById('v1').innerText = p.toFixed(4); document.getElementById('v2').innerText = avg.toFixed(4); 
                    document.getElementById('v3').innerText = (Math.abs(p*s.q)/eq).toFixed(2)+"x"; 
                    document.getElementById('v5').innerText = (avg * (1 - (s.margin / s.cost) + 0.005)).toFixed(4); 
                    document.getElementById('dispEquity').innerText = "$" + eq.toFixed(2); 
                    document.getElementById('dispPnlVal').innerText = (pl >= 0 ? "+$" : "-$") + Math.abs(pl).toFixed(2); 
                    document.getElementById('dispPnlPerc').innerText = (pP >= 0 ? "+" : "") + pP.toFixed(2) + "%"; 
                    const col = pl >= 0 ? "#00c853" : "#ff3d00"; 
                    document.getElementById('dispPnlVal').style.color = col; document.getElementById('dispPnlPerc').style.color = col; 
                } 
            } 
        }); 
        if (currentMode === "OVERVIEW") { 
            const tEq = gMarg + gPL, tP = gMarg > 0 ? (gPL/gMarg)*100 : 0;
            const col = gPL >= 0 ? "#00c853" : "#ff3d00";
            document.getElementById('dispEquity').innerText = "$" + tEq.toFixed(2); 
            document.getElementById('dispPnlVal').innerText = (gPL >= 0 ? "+$" : "-$") + Math.abs(gPL).toFixed(2); 
            document.getElementById('dispPnlPerc').innerText = (tP >= 0 ? "+" : "") + tP.toFixed(2) + "%";
            document.getElementById('dispPnlVal').style.color = col; document.getElementById('dispPnlPerc').style.color = col;
        } 
    }

    async function setMode(m, t="") {
        currentMode = m; currentSymbol = t;
        document.getElementById('overview-container').style.display = m === "OVERVIEW" ? "block" : "none";
        document.getElementById('mainDashboard').style.display = m === "OVERVIEW" ? "none" : "grid"; 
        const tickerContainer = document.getElementById('ticker-container');
        tickerContainer.style.display = m === "TICKER" ? "block" : "none";
        tickerContainer.innerHTML = ""; 

        if (m === "TICKER") {
            new TradingView.widget({
                "autosize": true, "symbol": "BINANCE:" + t + ".P", "interval": "15", "theme": "dark", "style": "1", "locale": "pt", 
                "container_id": "ticker-container", "hide_side_toolbar": false, "allow_symbol_change": true, 
                "withdateranges": true, "chart": MY_TV_CHART_ID, "enabled_features": ["header_widget"]
            });
        } else { 
            await updateOverview('5', document.getElementById('btn5m')); 
            await updateBarChart('D', document.getElementById('bar1d'));
        }
        updateAssetNav(); renderTable(); updateUI();
    }

    async function updateOverview(interval, btn) { 
        if(btn) { document.querySelectorAll('#lineControls .nav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } 
        const minDate = allTrades.length > 0 ? Math.min(...allTrades.map(t => new Date(t.created_at).getTime())) / 1000 : 0;
        const tickers = [...new Set(allTrades.map(t => t.par))]; 
        document.getElementById('bottomLegend').innerHTML = ''; 
        if(mainLine) chart.removeSeries(mainLine); if(zeroLine) chart.removeSeries(zeroLine);
        Object.values(subLines).forEach(s => chart.removeSeries(s)); subLines = {};

        zeroLine = chart.addLineSeries({ color: '#222', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
        zeroLine.setData([{ time: minDate, value: 0 }, { time: 2147483647, value: 0 }]);

        mainLine = chart.addLineSeries({ color: '#f3d42f', lineWidth: 3, priceLineVisible: false, lastValueVisible: true });
        createLegendItem("TOTAL", "#f3d42f");

        let composite = {};
        for (const t of tickers) { 
            const r = await fetch(`https://api.bybit.com/v5/market/kline?category=linear&symbol=${t}&interval=${interval}&limit=300`); 
            const j = await r.json(); 
            if (j.result?.list) {
                const data = j.result.list.map(v => ({ t: parseInt(v[0])/1000, c: parseFloat(v[4]) })).reverse().filter(p => p.t >= minDate - 3600); 
                const pos = getPosition(t); const color = colors[(tickers.indexOf(t)+1)%colors.length]; 
                const series = chart.addLineSeries({ color, lineWidth: 1.2, priceLineVisible: false, lastValueVisible: true }); 
                subLines[t] = series; 
                data.forEach(p => {
                    const val = (p.c - (pos.cost/pos.q)) * pos.q;
                    composite[p.t] = (composite[p.t] || 0) + val;
                });
                series.setData(data.map(p => ({ time: p.t, value: (p.c - (pos.cost/pos.q)) * pos.q })));
                series.applyOptions({ visible: seriesVisibility[t] !== false });
                createLegendItem(t, color); 
            } 
        } 
        const totalData = Object.keys(composite).sort().map(time => ({ time: parseInt(time), value: composite[time] }));
        if(totalData.length > 0) mainLine.setData(totalData);
        mainLine.applyOptions({ visible: seriesVisibility["TOTAL"] !== false });
        chart.timeScale().fitContent(); 
    }

    async function updateBarChart(interval, btn) {
        if(btn) { document.querySelectorAll('#barControls .nav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        if(barSeries) barChart.removeSeries(barSeries);
        barSeries = barChart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceLineVisible: false });
        const tickers = [...new Set(allTrades.map(t => t.par))];
        let aggregatedData = {};
        for (const t of tickers) {
            const r = await fetch(`https://api.bybit.com/v5/market/kline?category=linear&symbol=${t}&interval=${interval}&limit=15`);
            const j = await r.json();
            if (j.result?.list) {
                const pos = getPosition(t);
                j.result.list.forEach(v => {
                    const time = parseInt(v[0])/1000;
                    const change = (parseFloat(v[4]) - parseFloat(v[1])) * pos.q;
                    aggregatedData[time] = (aggregatedData[time] || 0) + change;
                });
            }
        }
        const finalBars = Object.keys(aggregatedData).sort().map(time => ({ time: parseInt(time), value: aggregatedData[time], color: aggregatedData[time] >= 0 ? '#00c853bb' : '#ff3d00bb' }));
        barSeries.setData(finalBars.slice(-10));
        barChart.timeScale().fitContent();
    }
    
    function createLegendItem(l, c) {
        if (seriesVisibility[l] === undefined) seriesVisibility[l] = true;
        const div = document.createElement('div');
        div.className = `legend-item ${seriesVisibility[l] ? '' : 'hidden'}`;
        div.innerHTML = `<div class="legend-color" style="background:${c}"></div><span>${l}</span>`;
        div.onclick = () => {
            seriesVisibility[l] = !seriesVisibility[l];
            if (l === "TOTAL") mainLine.applyOptions({ visible: seriesVisibility[l] });
            else if (subLines[l]) subLines[l].applyOptions({ visible: seriesVisibility[l] });
            div.classList.toggle('hidden', !seriesVisibility[l]);
        };
        document.getElementById('bottomLegend').appendChild(div);
    }
    
    window.onload = async () => { 
        chart = LightweightCharts.createChart(document.getElementById('chart'), { layout: { background: { color: 'transparent' }, textColor: '#444', fontSize: 10 }, grid: { vertLines: false, horzLines: false }, rightPriceScale: { borderVisible: false }, timeScale: { borderVisible: false } }); 
        barChart = LightweightCharts.createChart(document.getElementById('bar-chart'), { layout: { background: { color: 'transparent' }, textColor: '#444', fontSize: 10 }, grid: { vertLines: false, horzLines: false }, rightPriceScale: { borderVisible: false }, timeScale: { borderVisible: false } });
        await fetchPrices(); const { data } = await _supabase.from('trades').select('*').order('created_at', { ascending: true }); allTrades = data || []; 
        updateAssetNav(); renderTable(); await setMode("OVERVIEW"); setInterval(async () => { await fetchPrices(); updateUI(); }, 5000); 
    };

    function updateAssetNav() { const n = document.getElementById('assetNav'); const tics = [...new Set(allTrades.map(t => t.par))]; n.innerHTML = `<button class="nav-btn ${currentMode==='OVERVIEW'?'active':''}" onclick="setMode('OVERVIEW')">GERAL</button>`; tics.forEach(t => { n.innerHTML += `<button class="nav-btn ${currentMode==='TICKER'&&currentSymbol===t?'active':''}" onclick="setMode('TICKER', '${t}')">${t}</button>`; }); }
    async function saveTrade() { const id = document.getElementById('editId').value; const p = { par: document.getElementById('parTicker').value.toUpperCase(), tipo: document.getElementById('tType').value, preco: parseFloat(document.getElementById('tPrice').value), quantidade: parseFloat(document.getElementById('tQty').value), alavancagem_alvo: parseFloat(document.getElementById('tLev').value) }; if(id) await _supabase.from('trades').update(p).eq('id', id); else await _supabase.from('trades').insert([p]); location.reload(); }
    function editTrade(id) { const t = allTrades.find(x => x.id == id); document.getElementById('editId').value = t.id; document.getElementById('parTicker').value = t.par; document.getElementById('tType').value = t.tipo; document.getElementById('tPrice').value = t.preco; document.getElementById('tLev').value = t.alavancagem_alvo; document.getElementById('tQty').value = t.quantidade; document.getElementById('execBtn').innerText = "UPDATE"; document.getElementById('editLabel').style.display = "block"; document.getElementById('resetBtn').style.display = "block"; }
    function resetForm() { document.getElementById('editId').value = ""; document.getElementById('parTicker').value = ""; document.getElementById('tPrice').value = ""; document.getElementById('tQty').value = ""; document.getElementById('execBtn').innerText = "EXECUTE"; document.getElementById('editLabel').style.display = "none"; document.getElementById('resetBtn').style.display = "none"; }
    function renderTable() { const f = currentMode === "TICKER" ? allTrades.filter(t => t.par === currentSymbol) : allTrades; document.getElementById('tradeLog').innerHTML = f.slice().reverse().map(t => `<tr><td>${new Date(t.created_at).toLocaleDateString()}</td><td style="color:#fff;font-weight:700">${t.par}</td><td><span class="${t.tipo==='Compra'?'badge-long':'badge-short'}">${t.tipo==='Compra'?'LONG':'SHORT'}</span></td><td>${t.preco}</td><td>${t.quantidade}</td><td>$${(t.preco*t.quantidade).toFixed(2)}</td><td>${t.alavancagem_alvo}x</td><td class="action-btns"><button onclick="editTrade('${t.id}')">üìù</button><button onclick="deleteTrade('${t.id}')">üóëÔ∏è</button></td></tr>`).join(''); }
    function exportToCSV() { let csv = "Ativo,Lado,Preco,Qtd,USD\n"; allTrades.forEach(t => { csv += `${t.par},${t.tipo},${t.preco},${t.quantidade},${t.preco*t.quantidade}\n`; }); const blob = new Blob([csv], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'trades.csv'; a.click(); }
    async function deleteTrade(id) { if(confirm("Delete?")) { await _supabase.from('trades').delete().eq('id', id); location.reload(); } }
</script>
</body>
</html>
